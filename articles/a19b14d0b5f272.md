---
title: "Zip ã‚’è¡¨ã™Opticsã€ãã‚ŒãŒ Grate"
emoji: "ğŸ—œï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Haskell, PureScript, Lens, Optics, Grate]
published: true
publication_name: trap
---

:::message
åŸºæœ¬çš„ã« PureScript ã‚’ç”¨ã„ã¦èª¬æ˜ã‚’ã—ã¾ã™ã€‚

ä»Šå›æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã¯ [GratePlayGround.purs (yukikurage/free-exists)](https://github.com/yukikurage/free-exists/blob/master/src/GratePlayGround.purs) ã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚
:::

## åˆã‚ã«

æœ€è¿‘(ä¸»ã«è‡ªåˆ†ã®)TL ã§ã«ã‚ã‹ã«æµè¡Œã‚’è¦‹ã›ã¦ã„ã‚‹ Optics _a.k.a. Lens_ ã§ã™ãŒã€2015 å¹´ã« Grate ã¨ã„ã† Optics ãŒç™»å ´ã—ã¦ã„ãŸã®ã‚’ã”å­˜ã˜ã§ã—ã‚‡ã†ã‹ï¼Ÿ PureScript ã® Optics ãƒ©ã‚¤ãƒ–ãƒ©ãƒª [purescript-profunctor-lenses](https://pursuit.purescript.org/packages/purescript-profunctor-lenses) ã«ã¯ Grate Optics ãŒæ¡ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ã€Grate Optics ã«ã¤ã„ã¦è§¦ã‚ŒãŸæ—¥æœ¬èªè¨˜äº‹ã¯ç›¸å½“å°‘ãªãã†ãªã®ã§ã€è‡ªèº«ã®æ•´ç†ã‚‚å…¼ã­ã¦è¨˜äº‹ã«ã—ã¾ã™ã€‚

Optics ã®ãƒ’ã‚¨ãƒ©ãƒ«ã‚­ãƒ¼ãªã©ã€Optics å…¨ä½“ã«ã¤ã„ã¦ã‚‚è»½ãã¾ã¨ã‚ã¦ã„ã‚‹ã®ã§ Optics åˆ†ã‹ã‚‰ã‚“ã¨ã„ã†æ–¹ã«ã‚‚èª­ã‚“ã§ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼

## Grate Optics

Grate ã®åˆå‡ºã¯ã‚³ã‚³ï¼Ÿã ã¨æ€ã„ã¾ã™

https://r6research.livejournal.com/28050.html

æ›°ãã€Grate ã¯ Closed ãª p ã«å¯¾ã™ã‚‹ `Optics p` ã§ã™ã€‚(ï¼Ÿï¼Ÿ)

### Optics ã®å¾©ç¿’

`Optics` ã¨ã¯æ¬¡ã®ã‚ˆã†ãªå‹ã§ã™:

```hs
type Optics p s t a b = p a b -> p s t
```

ã“ã® `p` ã«è‰²ã€…ãªå‹ã‚¯ãƒ©ã‚¹ã§è‰²ã€…ãªåˆ¶ç´„ã‚’æ›ã‘ã‚‹ã“ã¨ã§ã€Lens ã‚„ Prism ãªã©ã® Optics ã«ãªã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™:

| åç§°            | åˆ¶ç´„           | ãŠæ°—æŒã¡       |
| --------------- | -------------- | -------------- |
| Iso             | Profunctor     | åŒå‹           |
| Lens            | Strong         | ç›´ç©ã®ç‰‡æ–¹     |
| Prism           | Choice         | ç›´å’Œã®ç‰‡æ–¹     |
| AffineTraversal | Strong, Choice | 0 ~ 1 å€‹ã®è¦ç´  |
| Traversal       | Wander         | 0 ~ n å€‹ã®è¦ç´  |

:::message
å‹ã‚¯ãƒ©ã‚¹ã®ãƒ’ã‚¨ãƒ©ãƒ«ã‚­ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™:

- Strong ãªã‚‰ã° Profunctor
- Choice ãªã‚‰ã° Profunctor
- Wander ãªã‚‰ã° Strong ã ã— Choice

ã—ãŸãŒã£ã¦ Lens ã®åˆ¶ç´„ã¯å®Ÿè³ªã€ŒProfunctor, Strongã€ã«ãªã‚Šã¾ã™ã—ã€Traversal ã®åˆ¶ç´„ã¯ã€ŒProfunctor, Strong, Choice, Wanderã€ã«ãªã‚Šã¾ã™ã€‚

ã‚³ã‚³ãŒã¡ã‚‡ã£ã¨ã‚„ã‚„ã“ã—ã„ã§ã™ãŒã€åˆ¶ç´„ãŒå¼·ã„ã»ã©ã€å½“ã¦ã¯ã¾ã‚‹å‹ãŒå¤šããªã‚Šã¾ã™ã€‚Optics ã‚’å®šç¾©ã™ã‚‹ã¨ãã« p ã®åˆ¶ç´„ãŒå¤šã„æ–¹ãŒé–¢æ•° p a b -> p s t ã‚’ä½œã‚Šã‚„ã™ã„ã€ã¨ã„ã†äº‹ã§ã™ã­ã€‚

ã—ãŸãŒã£ã¦ã“ã‚Œã‚‰ã® Optics ã«ã¯ã€ŒIso ãªã‚‰ã° Lensã€ã€ŒLens ãªã‚‰ã° Traversalã€ã¿ãŸã„ãªé–¢ä¿‚ãŒæˆã‚Šç«‹ã£ã¦ã„ã‚‹è¨³ã§ã™ã€‚ã“ã®é–¢ä¿‚ã¯å¾Œã«ã‚ã‹ã‚Šã‚„ã™ã„å›³ã§ã¾ã¨ã‚ã¾ã™ã€‚
:::

### Closed ã®å°å…¥

ã“ã“ã§ã€`p` ã®åˆ¶ç´„ã« `Closed` ã‚’ä»˜ã‘ãŸã‚‚ã®ãŒ Grate ã§ã™:

| åç§°  | åˆ¶ç´„   | ãŠæ°—æŒã¡   |
| ----- | ------ | ---------- |
| Grate | Closed | zip å¯èƒ½ï¼Ÿ |

`Closed` ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒª [purescript-profunctor](https://pursuit.purescript.org/packages/purescript-profunctor/docs/Data.Profunctor.Closed#t:Closed) ã§å®šç¾©ã•ã‚Œã¦ã„ã¦ã€æ¬¡ã®ã‚ˆã†ãªå‹ã‚¯ãƒ©ã‚¹ã§ã™:

```haskell
class Profunctor p <= Closed p where
  closed :: forall a b x. p a b -> p (x -> a) (x -> b)
```

`Strong` ã‚„ `Choice` ãŒ `Tuple` ã‚„ `Either` ã‚’å°å…¥ã—ã¦ã„ã‚‹ã®ã¨åŒã˜ã‚ˆã†ã« `Function` ã‚’å°å…¥ã—ãŸã‚‚ã®ã§ã™ã­:

```haskell
class Profunctor p <= Strong p where
  first :: forall a b c. p a b -> p (Tuple a c) (Tuple b c)
  second :: forall a b c. p b c -> p (Tuple a b) (Tuple a c)

class Profunctor p <= Choice p where
  left :: forall a b c. p a b -> p (Either a c) (Either b c)
  right :: forall a b c. p b c -> p (Either a b) (Either a c)
```

ç†è«–çš„ãªäº‹ã¯ã‚ˆãã‚ã‹ã£ã¦ã„ãªã„ã®ã§åœè«–ã¨ã‹ã§ä½•ã‚’æ„å‘³ã™ã‚‹ã®ã‹ã¯çŸ¥ã‚Šã¾ã›ã‚“ãŒã€ç›´æ„Ÿçš„ã«ã¯æ¬¡ãŒè¨€ãˆãã†ã§ã™:

- `Tuple` ã®ç‰‡æ–¹ã«æ³¨ç›®ã™ã‚‹ Optics ãŒ Lens ã§ã€`Either` ã®ç‰‡æ–¹ã«æ³¨ç›®ã™ã‚‹ Optics ãŒ Prism ãªã‚‰ã€`Function` ã®è¿”ã™å€¤ã«æ³¨ç›®ã™ã‚‹ã®ãŒ Grate ãªã‚“ã˜ã‚ƒãªã„ã‹ãªã‚¡ï½

å®Ÿã¯ã“ã®ç›´æ„Ÿã¯æ­£ã—ã„ã§ã™ã€‚è©³ã—ãã¯"ä¾‹"ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§â€¦â€¦

## Optics ã‚’ä½¿ã†å´

Optics ã¯ãã‚Œã‚‰ã‚’ä½¿ã†å´ã‚‚å¤§äº‹ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ Optics ã® `p` ã«å…·ä½“çš„ãªå‹ã‚’å…¥ã‚Œæ¶ˆè²»ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ãã®å‹ãŒæº€ãŸã™åˆ¶ç´„ã«ã‚ˆã£ã¦ã€ãã‚Œã‚‰ãŒã©ã® Optics ã«é©ç”¨ã§ãã‚‹ã‹ãŒå¤‰åŒ–ã™ã‚‹è¨³ã§ã™ã€‚

| åç§°       | p                              | æº€ãŸã™åˆ¶ç´„     | ä»£è¡¨çš„ãªã§ãã‚‹äº‹                           |
| ---------- | ------------------------------ | -------------- | ------------------------------------------ |
| Getter     | Forget a                       | Strong         | `view` å†…å´ã®å€¤ã®å–ã‚Šå‡ºã—                  |
| Fold       | Forget r (ãŸã ã— r ã¯ Monoid)  | Wander         | `toListOf` ãƒªã‚¹ãƒˆã¸ã®å¤‰æ›                  |
| Review     | Tagged                         | Choice, Closed | `review` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿(ã®ã‚ˆã†ãªã‚‚ã®)      |
| Setter     | (->)                           | Wander, Closed | `over` å†…å´ã®å€¤ã¸ã®é–¢æ•°é©ç”¨ _a.k.a. `map`_ |
| (Zipperï¼Ÿ) | Costar f (ãŸã ã— f ã¯ Functor) | Closed         | `zipFWithOf` Zip ã™ã‚‹                      |

:::message
Zipper ã¯ç‰¹æ®µåç§°ã¯ã¤ã„ã¦ã¾ã›ã‚“ã§ã—ãŸã€‚ãŸã åå‰ã‚’ä»˜ã‘ã‚‹ã¨ã—ãŸã‚‰ Zipper ãŒé©å½“ã‹ãªãã€ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
:::

è‚å¿ƒã® Grate ã¯ `zipFWithOf` é–¢æ•°ã«ã‚ˆã‚Šã€`p` ãŒ `Coastar f` ã¨ã„ã†å‹ã«ãªã‚Šæ¶ˆè²»ã•ã‚Œã¾ã™ã€‚è©³ã—ãã¯"ä¾‹"ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§â€¦â€¦2

### ãƒ’ã‚¨ãƒ©ãƒ«ã‚­ãƒ¼ã®å›³

ã“ã“ã¾ã§ã® `p` ã®åˆ¶ç´„ã‚„ `p` ã®å…·ä½“å‹ã®æº€ãŸã™åˆ¶ç´„ãªã©ã‚’åŠ å‘³ã—ã¦ã¾ã¨ã‚ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªãƒãƒƒã‚»å›³ã£ã½ã„ã‚‚ã®ãŒå‡ºæ¥ã¾ã™:

```mermaid
graph BT
    subgraph Optics
      Iso[Iso]
      Lens[Lens]
      Prism[Prism]
      Grate[Grate]
      AffineTraversal[AffineTraversal]
      Traversal[Traversal]
    end
    subgraph Usage
      Getter(Getter)
      Fold(Fold)
      Setter(Setter)
      Review(Review)
      Zipper(Zipper)
    end
    Iso --> Lens
    Iso --> Prism
    Iso --> Grate
    Lens -.-> Getter
    Lens --> AffineTraversal
    Prism --> AffineTraversal
    Prism -.-> Review
    Grate -.-> Setter
    Grate -.-> Review
    Grate -...-> Zipper
    AffineTraversal --> Traversal
    Traversal -.-> Fold
    Traversal -.-> Setter
```

è§’ãŒã¨ãŒã£ã¦ã„ã‚‹ã®ãŒ Optics, ä¸¸ã„ã®ãŒ Optics ã‚’ä½¿ã†å´ã§ã™ã€‚

çŸ¢å°ã¯ Optics ã®åŒ…å«é–¢ä¿‚ã‚’è¡¨ã—ã€ä¾‹ãˆã°ã€ŒIso ãªã‚‰ã° Lensã€ã€ŒLens ãªã‚‰ã° Traversalã€ã¨èª­ã‚ã¾ã™ã€‚

ç‚¹ç·šçŸ¢å°ã¯ã©ã®æ§˜ã«æ¶ˆè²»ã§ãã‚‹ã‹ã‚’è¡¨ã—ã€ä¾‹ãˆã°ã€ŒTraversal ãªã‚‰ Fold ã¨ã—ã¦ä½¿ãˆã‚‹ã€ã€ŒIso ãªã‚‰ã° Prism ãªã®ã§ Review ã¨ã—ã¦ä½¿ãˆã‚‹ã€ã¨èª­ã‚ã¾ã™ã€‚

## ä¾‹

ã•ã¦ã€Grate ã¯ Setter, Review, Zipeer ã¨ã—ã¦ä½¿ã†ã“ã¨ãŒå‡ºæ¥ãã†ã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯å…·ä½“çš„ãªå‹ã«ã¤ã„ã¦ Grate Optics ã‚’ä½œã‚Šã€ä½¿ã£ã¦ã¿ã¾ã™ã€‚

### Pair

æ¬¡ã®ã‚ˆã†ãª Pair å‹ã‚’è€ƒãˆã¾ã™ã€‚å˜ç´”ã« 2 ã¤çµ„ã‚’ä½œã‚‹ã‚‚ã®ã§ã™ã€‚

```haskell
data Pair a = Pair a a

derive instance Generic (Pair a) _

instance Show a => Show (Pair a) where
show = genericShow

-- | ä¸€ã¤ç›®ã®è¦ç´ ã‚’å–ã‚Šå‡ºã™
pFst :: forall a. Pair a -> a
pFst (Pair x \_) = x

-- | äºŒã¤ç›®ã®è¦ç´ ã‚’å–ã‚Šå‡ºã™
pSnd :: forall a. Pair a -> a
pSnd (Pair \_ y) = y
```

ã¾ãšã¯ Grate Optics ã‚’ä½œã‚Šã¾ã™ã€‚Grate ã‚’ä½œã‚‹ `grate` ã¨ã„ã†é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã¦ã€ãã‚Œã¯æ¬¡ã®ã‚ˆã†ãªã‚·ã‚°ãƒãƒãƒ£ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

```haskell
grate :: forall s t a b. (((s -> a) -> b) -> t) -> Grate s t a b
```

ãªã‚“ã ã‹ã™ã”ãéšå±¤ãŒæ·±ãã¦ã€Œé–¢æ•°ã‚’å–ã‚‹é–¢æ•°ã‚’å–ã‚‹é–¢æ•°ã‚’å–ã‚‹é–¢æ•°ã€ã«ãªã£ã¦ã¾ã™ãŒã€ä½¿ã£ã¦ã„ã‚‹ã®ã‚’è¦‹ã‚‹ã¨ä»¥å¤–ã«å˜ç´”ã§ã™:

```haskell
-- | Grate Optics ã®å®šç¾©
pairGrate :: forall a. Grate (Pair a) (Pair b) a b
pairGrate = grate \f -> Pair (f pFst) (f pSnd)
```

`grate` ã« `((s -> a) -> b) -> t` ã‚’æ¸¡ã›ã°è‰¯ã„ã®ã§ã€`f :: (s -> a) -> b` ã‚’å—ã‘å–ã£ã¦ `t` ã‚’è¿”ã™é–¢æ•°ãŒæ¬²ã—ã„ã§ã™ã€‚

ãã®ã‚ˆã†ãªé–¢æ•°ã®ä½œã‚Šæ–¹ã§ã™ãŒã€ã“ã® `f :: (s -> a) -> b` ã« `s -> a`ã€ã¤ã¾ã‚Šä½•ã‹ã—ã‚‰å€¤ã‚’å–ã‚Šå‡ºã™é–¢æ•°ã€â”€â”€`Pair` ã®å ´åˆ `pFst` ã¨ `pSnd`ã€ã‚’æ¸¡ã›ã°ãã‚Œãã‚Œ `b` ãŒå¾—ã‚‰ã‚Œã‚‹ã®ã§ã€ãã‚Œã‚‰ã‚’ã„ã„æ„Ÿã˜ã«çµ„ã¿åˆã‚ã›ã¦ `t` ã‚’ä½œã‚Œã°ã‚ˆã„ã§ã™ã€‚

ã¡ãªã¿ã«æ¡ä»¶ã•ãˆæº€ãŸã›ã°ã‚ˆã‚Šå˜ç´”ãªå®šç¾©ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã€ãã‚Œã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç´¹ä»‹ã—ã¾ã™ã€‚

ã•ã¦ã€`pairGrate` ã«å¯¾ã—ã¦ã€Reviewã€Setter ã®æ“ä½œã‚’è¡Œã„ã¾ã™:

```haskell
-- | Review ã®æ“ä½œ
-- | == Pair 1 1
pairReviewTest :: Pair Int
pairReviewTest = review pairGrate 1

-- | Setter ã®æ“ä½œ
-- | == Pair 2 3
pairSetterTest :: Pair Int
pairSetterTest = over pairGrate (\_ + 1) (Pair 1 2)
```

å‹ã‚¨ãƒ©ãƒ¼ã‚‚ãªãå‹•ã„ã¦ã„ã¾ã™ï¼

æœ€å¾Œã« Zipper ã®æ“ä½œã§ã™ãŒã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™:

```haskell
zipFWithOf :: forall f s t a b. Optic (Costar f) s t a b -> (f a -> b) -> (f s -> t)
```

ã¤ã¾ã‚Š `f a` ã‚’ `b` ã«å¤‰æ›ã™ã‚‹ã‚ˆã†ãªé–¢æ•°ã‚’æ¸¡ã›ã°ã€`f s` ã‚’ `t` ã«å¤‰æ›ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†:

```haskell
-- | Zipper ã®æ“ä½œ
-- | == Pair 4 6
pairZipperTest :: Pair Int
pairZipperTest = zipFWithOf pairGrate sum [ Pair 1 2, Pair 3 4 ]
```

ã“ã®ã‚ˆã†ã«ã€`f a -> a` ã¨ã—ã¦ `sum :: Array Int -> Int` ã‚’æ¸¡ã›ã°ã€`f s -> s` ã¨ã—ã¦ `Array (Pair Int) -> Pair Int` ãŒå…¥æ‰‹ã§ãã¾ã™ã€‚ã“ã‚Œã¯ `Pair`ã€€ã‚’å·¦å³ã«åˆ†å‰²ã—ã¦ãã‚Œãã‚Œ `sum` ã‚’å®Ÿè¡Œã—ã€æœ€å¾Œã«å†åº¦ `Pair` ã§ã¾ã¨ã‚ãŸã‚ˆã†ãªå‹•ä½œã‚’ã™ã‚‹é–¢æ•°ã§ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€zip ã£ã½ã„å‹•ä½œãŒã§ãã‚‹ã®ãŒ Grate ã®ç‰¹å¾´ã§ã™ã€‚

### Function

ã•ã¦ã€å®Ÿã¯é–¢æ•°(ã®å³è¾º)ã‚‚ Grate Optics ã¨ã—ã¦æ‰±ãˆã¾ã™ã€‚ã“ã‚ŒãŒ "Closed ã®å°å…¥" ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è§¦ã‚ŒãŸç‰©ã§ã™ã­ã€‚

ã“ã“ã§ã¯ `Int` ã‚’å¼•æ•°ã«å–ã‚‹ã‚ˆã†ãªãƒŠã‚¤ã‚¹ãªé–¢æ•°ã‚’è€ƒãˆã¦ã¿ã¾ã™:

```haskell
type NiceFunction a = Int -> a
```

ã“ã®å³è¾ºã€a ã«æ³¨ç›®ã™ã‚‹ã‚ˆã†ãª Grate Optics ãŒæ¬²ã—ã„ã‚ã‘ã§ã™ã­ã€‚ãã‚Œã§ã¯ä½œã‚Šã¾ã™:

```haskell
niceFunctionGrate :: forall a. Grate (NiceFunction a) (NiceFunction b) a b
niceFunctionGrate = grate \f -> \n -> f \nf -> nf n
```

æµçŸ³ã«ã‚„ã‚„ã“ã—ã„ã§ã™ã­ã€‚`Pair` ã§ã¯ã¾ã ãƒã‚·ã§ã—ãŸãŒã€ãŸã ã§ã•ãˆé–¢æ•°ãŒãƒã‚¹ãƒˆã—ã¦ã„ãŸã®ã«ã•ã‚‰ã«é–¢æ•°ã‚’æ‰±ãŠã†ã¨ã—ã¦ã„ã‚‹ã®ã§ã€ãªã‚“ã¨ã€Œé–¢æ•°ã‚’å–ã‚‹é–¢æ•°ã‚’å–ã‚‹é–¢æ•°ã‚’å–ã£ã¦é–¢æ•°ã‚’è¿”ã™é–¢æ•°ã‚’å–ã‚‹é–¢æ•°ã€ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã§ã¯å®Ÿç”¨ã«è€ãˆãªã„ã®ã§ã€Grate Optics ã‚’ä½œã‚‹ã‚‚ã†ä¸€ã¤ã®æ–¹æ³• `contraversed` ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã“ã‚Œã¯æ¬¡ã®ã‚ˆã†ãªã‚·ã‚°ãƒãƒãƒ£ã‚’æŒã£ã¦ã„ã¾ã™:

```haskell
contraversed :: forall f a b. Distributive f => Grate (f a) (f b) a b
```

`Distributive` ã§ã‚ã‚‹ã‚ˆã†ãª `f` ã«å¯¾ã—ã¦ã¯ `Grate (f a) (f b) a b` ãŒä½œã‚Œã‚‹ã¨ã„ã†ã“ã¨ã‚‰ã—ã„ã§ã™ã€‚

`Distributive` ã¯ [purescript-distributive](https://pursuit.purescript.org/packages/purescript-distributive/docs/Data.Distributive#t:Distributive) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å‹ã‚¯ãƒ©ã‚¹ã§ã€Traversable ã®åŒå¯¾ã‚‰ã—ã„ã§ã™ãŒã€è©³ã—ã„ã“ã¨ã¯å…¨ç„¶çŸ¥ã‚‰ãªã„ã®ã§å‰²æ„›ã—ã¾ã™â€¦â€¦

ã¨ã‚‚ã‹ãã€å®Ÿéš›ã« `Function e` ã¯ `Distributive` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚‹ã®ã§ã€æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã§ãã¾ã™:

```haskell
niceFunctionGrate :: forall a. Grate (NiceFunction a) (NiceFunction b) a b
niceFunctionGrate = cotraversed
```

ç°¡å˜ãƒƒãƒƒãƒƒï¼ï¼ç°¡å˜ãƒƒãƒƒï¼ï¼ï¼

ã•ã¦ã€`Pair` ã¨åŒæ§˜ã«ã“ã® Grate Optics ã«å¯¾ã—ã¦ Reviewã€Setterã€Zipper ã®æ“ä½œã‚’é©ç”¨ã—ã¦ã„ãã¾ã™:

```haskell
-- | niceFunctionHello 1 == "Hello"
-- | niceFunctionHello 4 == "Helloooo"
niceFunctionHello :: NiceFunction String
niceFunctionHello n = "Hell" <> power "o" n

-- | niceFunctionHello 1 == "World"
-- | niceFunctionHello 4 == "Worrrrld"
niceFunctionWorld :: NiceFunction String
niceFunctionWorld = \n -> "Wo" <> power "r" n <> "ld"

-- | Review ã®æ“ä½œ
-- | å¸¸ã« "Const" ã‚’è¿”ã™é–¢æ•°ã«ãªã‚‹
niceFunctionReviewTest :: NiceFunction String
niceFunctionReviewTest = review niceFunctionGrate "Const"

-- | Setter ã®æ“ä½œ
-- | çµæœã®å€¤ã« ! ã‚’è¿½åŠ 
-- | niceFunctionSetterTest 1 == "Hello!"
-- | niceFunctionSetterTest 4 == "Helloooo!"
niceFunctionSetterTest :: NiceFunction String
niceFunctionSetterTest = over niceFunctionGrate (_ <> "!") niceFunctionHello

-- | Zipper ã®æ“ä½œ
-- | niceFunctionZipperTest 1 == "Hello World"
-- | niceFunctionZipperTest 4 == "Helloooo Worrrrld"
niceFunctionZipperTest :: NiceFunction Int
niceFunctionZipperTest = zipFWithOf niceFunctionGrate intercalate " " [ niceFunctionHello, niceFunctionWorld ]
```

å•é¡Œãªãå‹•ã„ã¦ã„ã¾ã™ã­ï¼

### ä»–ã® Optics ã¨ã®çµ„ã¿åˆã‚ã›

ã•ã¦ã€Grate ã¯ä»–ã® Optics ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ã†ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚Lens ã‚„ Prism ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ Zipper ã¨ã—ã¦ã¯ä½¿ãˆãªããªã£ã¦ã—ã¾ã†ã®ã§ã™ãŒã€å¼•ãç¶šã Review ã‚„ Setter ã¨ã—ã¦ã¯ä½¿ãˆã‚‹ã®ã§ã€è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

#### w/ Lens

ã•ã¦ã€æ¬¡ã®ã‚ˆã†ãªå‹ã‚’è€ƒãˆã¾ã™:

```haskell
type WithLens a = NiceFunction { hello :: a, world :: String }
```

ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸­ã® hello ã«æ³¨ç›®ã™ã‚‹ Lens ã‚’ä½œã‚ŠãŸã„ã§ã™ãŒã€`prop` ã§ä¸€ç™ºã§ã™ã€‚Row Polymorphism ã«æ„Ÿè¬:

```haskell
helloLens :: forall a b r. Lens { hello :: a | r } { hello :: b | r } a b
helloLens = prop (Proxy :: Proxy "hello")
```

ã•ã¦ã€ãƒ’ã‚¨ãƒ©ãƒ«ã‚­ãƒ¼ã‚’è¦‹ã‚‹ã¨ã€Lens ã¨ Grate ã®çµ„ã¿åˆã‚ã›ã«ã¯ Setter ãŒä½¿ãˆã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã®ã§ã€ã•ã£ããä½¿ã£ã¦ã¿ã¾ã™:

```haskell
-- | hello ã«ãã®ã¾ã¾ n ã‚’çªã£è¾¼ã‚€ NiceFunction
before :: WithLens Int
before = \n -> { hello: n, world: "world" }

-- | çµæœã® hello ã« show ã‚’é©ç”¨
after :: WithLens String
after = over (niceFunctionGrate <<< helloLens) show before
```

Grate ã‚’çµŒç”±ã™ã‚‹ã¨ã§ãã‚‹æ“ä½œãŒçµæ§‹é™ã‚‰ã‚Œã¡ã‚ƒã„ã¾ã™ãŒã€ã“ã®ã‚ˆã†ã«é–¢æ•°ã‚‚ Optics ã®å¯¾è±¡ã¨ã—ã¦æ‰±ã£ã¦ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ã‚ˆã‚Šæ·±ã„éƒ¨åˆ†ã¾ã§æ½œã‚Œã‚‹ã®ã¯å¬‰ã—ã„ã§ã™ã­ã€‚

#### w/ Prism

Prism ã¨ã®çµ„ã¿åˆã‚ã›ã§ã¯ã€Review ãŒä½¿ãˆã¾ã™:

```haskell
type WithPrism a = NiceFunction (Either a Int)

-- | å¸¸ã« `Left "I think I'm on the left."` ã‚’è¿”ã™
reviewed :: WithPrism String
reviewed = review (niceFunctionGrate <<< _Left) "I think I'm on the left."
```

å¸¸ã« `Left "I think I'm on the left."` ã‚’è¿”ã™é–¢æ•°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

#### w/ Grate

ã‚‚ã¡ã‚ã‚“ Grate è‡ªèº«ãƒã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ã¡ã‚‡ã†ã©ã“ã“ã« `Pair` ã¨ `NiceFunction` ã¨ã„ã†äºŒã¤ã® Grate Optics ã®å¯¾è±¡ãŒã‚ã‚‹ã®ã§çµ„ã¿åˆã‚ã›ã¦ã¿ã¾ã™:

```haskell
-- | NiceFunction ã®äºŒã¤çµ„
type NiceFunctionPair a = Pair (NiceFunction a)

-- | Review ã®æ“ä½œ
-- | å¸¸ã« "Const" ã‚’è¿”ã™é–¢æ•°ã® Pair ãŒã§ãã‚‹
niceFunctionPairReviewTest :: NiceFunctionPair String
niceFunctionPairReviewTest = review (pairGrate <<< niceFunctionGrate) "Const"

-- | ãƒ†ã‚¹ãƒˆç”¨ã® NiceFunctionPair
niceFunctionPair :: NiceFunctionPair String
niceFunctionPair = Pair niceFunctionHello niceFunctionWorld

-- | Setter ã®æ“ä½œ
-- | Pair ã®ãã‚Œãã‚Œã® NiceFunction ã®çµæœã« ! ã‚’è¿½åŠ 
niceFunctionPairSetterTest :: NiceFunctionPair String
niceFunctionPairSetterTest = over (pairGrate <<< niceFunctionGrate) (_ <> "!") niceFunctionPair

-- | Zipper ã®æ“ä½œ
-- | çµæœã®å€¤ Pair f g ã«å¯¾ã—ã¦
-- | f 5 == "Hellooooo Hellooooo"
-- | g 5 == "Worrrrrld Worrrrrld"
niceFunctionPairZipperTest =
  zipFWithOf
    (pairGrate <<< niceFunctionGrate)
    (intercalate " ")
    [ niceFunctionPair, niceFunctionPair ]
```

Grate åŒå£«ã§çµ„ã¿åˆã‚ã›ã‚‹åˆ†ã«ã¯ Zipper ãŒä½¿ãˆãªããªã£ãŸã‚Šã—ãªã„ã®ã§ã€æ€ã†å­˜åˆ†åˆæˆã§ãã¾ã™ã­ï¼

## ã¾ã¨ã‚

ã–ã£ã¨è¦‹ãŸæ„Ÿã˜ Grate ã¯ Zip ã§ãã‚‹ã¨ã„ã†æ€§è³ªã‚’è¡¨ã™ Opticsã€ã¨è¨€ãˆãã†ã§ã™ã€‚ã¾ãŸã€Zip ã§ãã‚‹ç‰¹æ€§ã¯å¤±ã‚ã‚Œã¾ã™ãŒã€ä»–ã® Optics ã¨çµ„ã¿åˆã‚ã›ã¦ã‚‚å•é¡Œãªãä½¿ãˆã¾ã™ã€‚

ã‚ã¨ã€`Pair` ã¯å®Ÿã¯ Traversal ã§ã‚‚ã‚ã‚‹ã®ã§ã€Grate ã¨ Traversal ã‚’åŒæ™‚ã«æº€ãŸã™ Optics ã¨ã‹ãã†ã„ã†ã®ã‚‚ç®¡ç†ã—ãŸã„ã‚ˆã­ã€ã¨æ€ã„ã¾ã—ãŸã€‚(çµ„åˆã›çˆ†ç™ºèµ·ããã†ãªæ°—ãŒã—ã¾ã™ãŒâ€¦â€¦)

Distributive ã¨ã®é–¢é€£ã¯ã¾ã ã‚ˆãåˆ†ã‹ã£ã¦ã„ãªã„ã®ã§ã€ã‚‚ã†å°‘ã—èª¿ã¹ã¦ã¿ãŸã„ã§ã™ã€‚

## æœ€å¾Œã«

Optics ã„ã„ã‚ˆã­ã€‚ã¿ã‚“ãªã‚‚ä½¿ãŠã†ã€Opticsã€‚
