---
title: "ãƒ‰ãƒ‰ã‚¹ã‚³ in PureScript"
emoji: "ğŸ’«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["PureScript"]
published: true
---

Ref: https://twitter.com/Sheeeeepla/status/1554028833942441984

é¢ç™½ã„å•é¡Œã ã¨æ€ã£ãŸã®ã§ã½ãæ›¸ããŸã‹ã£ãŸ

# ãƒ‰ãƒ‰ã‚¹ã‚³ãƒ¼ãƒ‰

```purs
module Main where

import Prelude

import Control.Monad.Rec.Class (Step(..), tailRecM)
import Data.List (List, length, reverse, (:), take)
import Data.List as List
import Effect (Effect)
import Effect.Console (log)
import Effect.Random (randomBool)

data Dodosuko = Dodo | Suko

derive instance Eq Dodosuko
instance showDodosuko :: Show Dodosuko where
  show Dodo = "ãƒ‰ãƒ‰"
  show Suko = "ã‚¹ã‚³"

ranDodosuko :: Effect Dodosuko
ranDodosuko = randomBool <#> if _ then Dodo else Suko

endodosukoList :: List Dodosuko
endodosukoList = reverse $ List.fromFoldable $ [ Dodo, Suko, Suko, Suko, Dodo, Suko, Suko, Suko, Dodo, Suko, Suko, Suko ]

endodosukoListLength :: Int
endodosukoListLength = length endodosukoList

dodoskoRec :: List Dodosuko -> Effect (Step (List Dodosuko) Unit)
dodoskoRec prevDodosukoList =
  if take endodosukoListLength prevDodosukoList == endodosukoList then do
    log "ãƒ©ãƒ–æ³¨å…¥â™¡"
    pure $ Done unit
  else do
    newDodosuko <- ranDodosuko
    log $ show newDodosuko
    pure $ Loop $ newDodosuko : prevDodosukoList

main :: Effect Unit
main = tailRecM dodoskoRec $ List.fromFoldable []

```

## List

PureScript ã§ã¯é…åˆ—ã¨ã—ã¦ `Array` ã‚’ä½¿ã†ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒã€`List` ã¨ã„ã†å…ˆé ­ã¸è¦ç´ ã‚’è¿½åŠ ã™ã‚‹æ“ä½œ `:` ãŒ O(1) ã§ã‚ã‚‹æ°¸ç¶šåŒ–å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿å‹ãŒã‚ã‚Šã¾ã™ (Haskell ã§ã¯ã“ã¡ã‚‰ã‚’ä¸€èˆ¬çš„ã«ä½¿ã†)
ãƒ‰ãƒ‰ã‚¹ã‚³ã‚’ `Array` ã«è²¯ã‚ã¦ã„ãã¨é…åˆ—ã®é•·ã•ã«æ¯”ä¾‹ã—ã¦è¿½åŠ æ“ä½œãŒé…ããªã£ã¦ã„ãã¾ã™ãŒã€ã“ã“ã§ `List` ã‚’ä½¿ã†äº‹ã§å…¨ä½“ã§ã®è¨ˆç®—é‡ã‚’ O(N) ã«ã—ã¦ã„ã¾ã™ã€‚(N ã¯ãƒ‰ãƒ‰ã‚¹ã‚³ã®é•·ã•ã®æœŸå¾…å€¤)

ãŸã ã— `List` ã¯å‰ã«è¦ç´ ãŒå¢—ãˆã¦ã„ãã®ã§ `endodosukoList` ã®ä¸­èº«ã¯ `reverse` ã§åè»¢ã•ã›ã¦ã„ã¾ã™

## MonadRec

PureScript ã§å†å¸°ã‚’ã™ã‚‹ã¨å¿…ãšã¨è¨€ã£ã¦ã„ã„ã»ã© `Maximum call stack size exceeded` ãŒèµ·ãã¦ã—ã¾ã„ã¾ã™ãŒã€`MonadRec` ã‚¯ãƒ©ã‚¹ãªã„ã— `tailRecM` é–¢æ•°ã‚’ä½¿ã†ã¨ãã‚Œã‚’å›é¿ã§ãã¾ã™ã€‚

https://pursuit.purescript.org/packages/purescript-tailrec/5.0.1/docs/Control.Monad.Rec.Class

ãªã‚“ã‹ã®é–¢æ•°ã‚’æ¸¡ã—ã¦ã€ãã‚ŒãŒ `Done ãªã«ã‹ã—ã‚‰` ã‚’è¿”ã™ã¨ãƒ«ãƒ¼ãƒ—ãŒçµ‚äº†ã—ã€`Loop ãªã«ã‹ã—ã‚‰` ã‚’è¿”ã™ã¨ã‚‚ã†ä¸€å›ãã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚`Effect` ã¯ `MonadRec` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã®ã§ã“ã‚ŒãŒå¯èƒ½ã§ã™ã€‚

# ãŠã¾ã‘

ã“ã‚Œã¯ `tailRecM` ã‚’ä½¿ã‚ãªã‹ã£ãŸã¨ãã®ã€Maximum call stack size exceeded ã‚¹ã‚³

![](/images/Maximum_call_stack_size_exceeded_suko.png)
